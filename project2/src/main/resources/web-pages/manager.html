<!DOCTYPE html>
<html lang="en">
<head>
    <title>Determine Reimbursement Status</title>
</head>
<body>
    <h1 style="text-align:center">Determine Reimbursement Status</h1>
    <h3>Requests Table</h3>
    <table style="background-color:#741B52; color:white">
        <thead>
            <tr>
                <th>Request id | </th><th>Employee name | </th><th>Reason given | </th><th>Requested amount | </th><th>Requested status | </th><th>action | </th>
                <th title="Reason must not exceed 500 characters." onmouseover="style.color='aquamarine'" onmouseleave="style.color='white'">Reason for approval/denial* | </th>
                <!-- could use some styling here - a border? -->
                <th></th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td></td>
            </tr>
        </tbody>
    </table>
</body>
<script>
    let baseURL = "http://localhost:8080/requests/"
    async function getAllRequests(){
        let config = {
            method: "GET",
            headers:{"Content-Type":"application/json"},
        }

        let httpResponse = await fetch(`${baseURL}`,config);
        
        if(httpResponse.status === 200){
            const requests = await httpResponse.json();
            for(let request of requests){
                console.log(request.request_reason, `requester_reason${request.id}`)
                let newRow = document.createElement("tr");
                newRow.innerHTML = `
                    <td id="${request.id}">${request.id}</td>
                    <td id="requester${request.id}">${request.requester_username}</td>
                    <td id="requester_reason${request.id}">${request.request_reason}</td>
                    <td id="amount${request.id}">${request.amount}</td>
                    <td id="requester_status${request.id}">${request.request_status}</td>
                    <td>
                        <select id = "status${request.id}"> 
                            <option id = "pending">Pending</option>
                            <option id = "approved">Approved</option>
                            <option id = "denied">Denied</option>
                        </select>
                    </td>
                    <td><input type="text" id="status_reason${request.id}"></td>
                    <button onclick="updateStatus(${request.id})">Update</button>
              
                    `;
                let tbody = document.getElementById("tbody");
                tbody.appendChild(newRow);
            }
        } else {
            alert("the getAllRequests function does not ...function");
        }
    }

    getAllRequests();


    async function updateStatus(id, requester_username, requester_reason, amount, status, status_reason){
        let requestStatus = {
            requester_username: requester_username.innerText,
            request_reason: requester_reason.innerText,
            amount: amount,
            request_status: status.value,
            status_reason: status_reason.value, // styling to auto-fit length to content
            manager_username: "dodgeball" // let's connect this to the credentials from the login page
        }

        let config = {
            method: "PATCH",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(requestStatus)
        }

        let httpResponse = await fetch(`${baseURL}${id}`, config);

        if(httpResponse.status === 204){
            alert(`Request status has been ${document.getElementById(status).value}.`);
        } else {
            console.log("the updateStatus function does not...function")
        }
    }

</script>
</html>