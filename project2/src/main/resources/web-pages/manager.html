<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manager</title>
</head>
<body>
    <h1>Manager Page Placeholder Name / Request Approval (or Denial) Page</h1>
    <h3>Requests Table</h3>
    <table>
        <thead>
            <tr>
                <th>Request id | </th><th>Employee name | </th><th>Requested amount | </th><th>Reason given | </th><th>Request status | </th>
                <th title="Reason must not exceed 500 characters." onmouseover="style.color='red'" onmouseleave="style.color='black'">Reason for approval/denial* | </th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr>
                <td></td>
            </tr>
        </tbody>
    </table>
    <select name="" id=""></select>
    <input type="text" id="" placeholder="Reason given">
    <select name="" id="">
        <option value="Accepted">Accepted</option>
        <option value="Denied">Denied</option>
    </select>
    <button>Update Button</button>
</body>
<script>
    let baseURL = "http://localhost:8080/requests/"
    async function getAllRequests(){
        let config = {
            method: "GET",
            headers:{"Content-Type":"application/json"},
        }

        let httpResponse = await fetch(`${baseURL}`,config);
        
        if(httpResponse.status === 200){
            /*
                convert httpResponse body into an array of objects
                for each request in an array of request objects
                    create a new row element
                    set innerHTML of the new row with the information of the record
                    append child row to the table body
            */
            const requests = await httpResponse.json();
            for(let request of requests){
                let submittedRequests = requests[request];
                let newRow = document.createElement("tr");
                newRow.innerHTML = `
                    <td>${request.id}</td>
                    <td>${request.requester_username}</td>
                    <td>${request.amount}</td>
                    <td>${request.request_reason}</td>
                    <td><select id = "${request.id}"> 
                        <option id = "pending">Pending</option>
                        <option id = "approved">Approved</option>
                        <option id = "denied">Denied</option>
                    </select></td>
                    <td><input type="text"></td>
                    <button onclick="updateStatus(${request.id})">Update</button>
                `;
                let tbody = document.getElementById("tbody");
                tbody.appendChild(newRow);
            }
        } else {
            alert("you done messed up");
        }
    }
    getAllRequests();

    async function updateStatus(requestIdParameter){
        let config = {
            method: "GET",
            headers:{"Content-Type":"application/json"},
        }

        let httpResponse = await fetch(`${baseURL}`,config);
        
        if(httpResponse.status === 200){
            const requests = await httpResponse.json();
            for(let request of requests){
                if (request.id === requestIdParameter) {
        
                    let requestStatus = {
                        requester_username: request.requester_username,
                        request_reason: request.request_reason,
                        amount: request.amount,
                        request_status: request.request_status,
                        status_reason: request.status_reason,
                        manager_username: request.manager_username
                    }

                    let config = {
                        method: "PATCH",
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify(requestStatus)
                    }

                    let httpResponse = await fetch(`${baseURL}${requestIdParameter}`, config);

                    if(httpResponse.status === 204){
                        alert(`Request status has been ${document.getElementById(requestIdParameter).value}.`);
                    } else {
                        console.log("everything is not supposed to be like this");
                    }
                } 
            }
        } else {
            alert("so messed up");
        }
    }

</script>
</html>